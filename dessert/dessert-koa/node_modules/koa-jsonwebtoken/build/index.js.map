{"version":3,"sources":["webpack:/webpack/bootstrap 304b6b4e6067a722de6d","webpack:/external \"es6-promisify\"","webpack:/external \"jsonwebtoken\"","webpack:/external \"koa-unless\"","webpack:/external \"util\"","webpack:///main.js"],"names":["__webpack_require__","moduleId","installedModules","exports","module","i","l","modules","call","m","c","value","d","name","getter","o","Object","defineProperty","configurable","enumerable","get","n","__esModule","object","property","prototype","hasOwnProperty","p","s","require","verifyAsync","__WEBPACK_IMPORTED_MODULE_3_es6_promisify___default","__WEBPACK_IMPORTED_MODULE_0_jsonwebtoken__","__WEBPACK_IMPORTED_MODULE_0_jsonwebtoken___default","a","opts","secret","Error","extractToken","__WEBPACK_IMPORTED_MODULE_2_util__","checkRevoked","doRefresh","key","middleware","_ref","_asyncToGenerator","ctx","next","accessToken","decodedToken","state","e","message","refreshToken","fromCookies","decodedAccessToken","ignoreExpiration","throw","_x","_x2","apply","this","arguments","unless","__WEBPACK_IMPORTED_MODULE_1_koa_unless___default","refresh","refreshCookie","cookies","cookie","__webpack_exports__","fromAuthorizationHeader","header","authorization","parts","split","length","scheme","credentials","test"],"mappings":"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","file":"./build/index.js","sourceRoot":"./main.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// identity function for calling harmony imports with the correct context\n \t__webpack_require__.i = function(value) { return value; };\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 4);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 304b6b4e6067a722de6d","module.exports = require(\"es6-promisify\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"es6-promisify\"\n// module id = 0\n// module chunks = 0","module.exports = require(\"jsonwebtoken\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"jsonwebtoken\"\n// module id = 1\n// module chunks = 0","module.exports = require(\"koa-unless\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"koa-unless\"\n// module id = 2\n// module chunks = 0","module.exports = require(\"util\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"util\"\n// module id = 3\n// module chunks = 0","import jwt, { verify, decode, sign } from \"jsonwebtoken\";\nimport unless from \"koa-unless\";\nimport { isFunction } from \"util\";\nimport promisify from \"es6-promisify\";\n\nconst verifyAsync = promisify(verify, jwt);\n\nexport { verify, decode, sign };\n\nexport default (opts = {}) => {\n\n  if (!opts.secret) {\n    throw new Error(\"secret must be specified\");\n  }\n\n  if (!opts.extractToken || !isFunction(opts.extractToken)) {\n    throw new Error(\"token extraction strategy must be specified and should be a function\");\n  }\n\n  if (opts.checkRevoked && !isFunction(opts.checkRevoked)) {\n    throw new Error(\"token revokation check must be a function\");\n  }\n\n  if (opts.doRefresh && !isFunction(opts.doRefresh)) {\n    throw new Error(\"token refresh strategy must be specified and should be a function\");\n  }\n\n  const {\n    secret,\n    key = \"user\",\n    extractToken,\n    checkRevoked = false,\n    doRefresh = false\n  } = opts;\n\n  const middleware = async (ctx, next) => {\n    try {\n      const accessToken = extractToken(ctx, opts);\n      const decodedToken = await verifyAsync(accessToken, secret, opts);\n      if (checkRevoked) {\n        await checkRevoked(decodedToken, opts);\n      }\n      ctx.state = ctx.state || {};\n      ctx.state[key] = decodedToken;\n    } catch (e) {\n      if (e.message === \"jwt expired\" && doRefresh) {\n        try {\n          const refreshToken = fromCookies(ctx, opts, true);\n          const accessToken = extractToken(ctx, opts);\n          const decodedAccessToken = await verifyAsync(accessToken, secret, { ignoreExpiration: true });\n          await doRefresh(ctx, opts, refreshToken, decodedAccessToken);\n          ctx.state = ctx.state || {};\n          ctx.state[key] = decodedAccessToken;\n        } catch (e) {\n          ctx.throw(401, `Invalid token - ${e.message}`);\n        }\n        await next();\n      } else ctx.throw(401, `Invalid token - ${e.message}`);\n    }\n    await next();\n  }\n\n  middleware.unless = unless;\n\n  return middleware;\n\n}\n\nexport const fromCookies = (ctx, opts, refresh=false) => {\n  if (refresh) {\n    if (opts.refreshCookie && ctx.cookies.get(opts.refreshCookie)) {\n      return ctx.cookies.get(opts.refreshCookie);\n    } else {\n      throw new Error(`the refresh cookie was not found\\n`);\n    }\n  } else if (opts.cookie && ctx.cookies.get(opts.cookie)) {\n    return ctx.cookies.get(opts.cookie);\n  } else {\n    throw new Error(`the specified cookie was not found\\n`);\n  }\n}\n\nexport const fromAuthorizationHeader = (ctx, opts) => {\n  if (!ctx.header || !ctx.header.authorization) {\n    throw new Error(`can't find authorization header`);\n  }\n  const parts = ctx.header.authorization.split(\" \");\n  if (parts.length === 2) {\n    const scheme = parts[0];\n    const credentials = parts[1];\n    if (/^Bearer$/i.test(scheme)) {\n      return credentials;\n    } else {\n      throw new Error(`Bad Authorization header format. Format is \"Authorization: Bearer token\"\\n`);\n    }\n  } else {\n    throw new Error(`Bad Authorization header format. Format is \"Authorization: Bearer token\"\\n`);\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./main.js"]}